---
phase: 5
plan: 2
depends_on: [1]
must_haves:
  - "Coding agent extension auto-loads client knowledge on session start"
  - "Extension registers /knowledge commands for search and indexing"
  - "Client AGENTS.md and past decisions are injected into context"
---

# Phase 5, Plan 2: Knowledge Base Coding Agent Extension

## Goal
Create a coding-agent extension that auto-loads client context and provides knowledge management commands.

## Context
Extension follows Pi Agent factory pattern. On session_start, detects client from cwd, loads relevant knowledge, injects into system prompt via before_agent_start event.

## Tasks

<task type="auto">
  <n>Create knowledge extension entry point</n>
  <files>packages/knowledge/src/extension.ts</files>
  <action>
    Create extension factory following Pi Agent pattern:
    
    import type { ExtensionFactory } from "@draht/coding-agent";
    
    export const knowledgeExtension: ExtensionFactory = (pi) => {
      let manager: KnowledgeManager | null = null;
      
      // On session_start: detect client, initialize knowledge manager
      pi.on("session_start", async (event, ctx) => {
        const config = loadClientConfig(ctx.cwd);
        if (!config) return;
        manager = new KnowledgeManager(config.slug);
        // Auto-index AGENTS.md if present
        if (config.agentsMdPath) {
          await manager.indexFile(config.agentsMdPath);
        }
      });
      
      // On before_agent_start: inject relevant knowledge into system prompt
      pi.on("before_agent_start", async (event, ctx) => {
        if (!manager) return;
        const results = await manager.searchKnowledge(event.prompt, 'general');
        if (results.length === 0) return;
        const knowledgeContext = formatKnowledgeForPrompt(results);
        return { systemPrompt: event.systemPrompt + "\n\n" + knowledgeContext };
      });
      
      // Register /knowledge command
      pi.registerCommand("knowledge", {
        description: "Manage client knowledge base (index, search, forget)",
        handler: async (args, ctx) => { ... }
      });
    };
    
    Helper: formatKnowledgeForPrompt(results) — formats search results as XML block for system prompt injection.
  </action>
  <verify>bun run --cwd packages/knowledge tsgo --noEmit src/extension.ts 2>&1 | head -5</verify>
  <done>Extension compiles and hooks into session_start + before_agent_start events</done>
</task>

<task type="auto">
  <n>Implement knowledge CLI commands</n>
  <files>packages/knowledge/src/commands.ts</files>
  <action>
    Create command handler functions:
    
    - handleKnowledgeCommand(args: string, manager: KnowledgeManager, ctx): 
      Parse subcommand from args:
      - "index [path]" — index a file or directory into knowledge base
      - "search <query>" — search knowledge and display results
      - "forget <source>" — remove knowledge from a specific source file
      - "status" — show indexed files count, client slug, db size
      - No args — show usage help
    
    Each subcommand uses ctx.ui.notify() for feedback.
    Search results displayed via ctx.ui for interactive mode.
  </action>
  <verify>bun run --cwd packages/knowledge tsgo --noEmit src/commands.ts 2>&1 | head -5</verify>
  <done>All /knowledge subcommands implemented</done>
</task>

<task type="auto">
  <n>Export extension and update package.json</n>
  <files>packages/knowledge/src/index.ts, packages/knowledge/package.json</files>
  <action>
    1. Add extension export to index.ts: export { knowledgeExtension } from "./extension.js"
    2. Add exports map to package.json for extension entry:
       "exports": {
         ".": { "types": "./dist/index.d.ts", "import": "./dist/index.js" },
         "./extension": { "types": "./dist/extension.d.ts", "import": "./dist/extension.js" }
       }
    3. Add @draht/coding-agent as devDependency (for extension types)
  </action>
  <verify>grep -A2 extension packages/knowledge/package.json</verify>
  <done>Extension is importable from @draht/knowledge/extension</done>
</task>
