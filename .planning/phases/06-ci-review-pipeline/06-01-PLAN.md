---
phase: 6
plan: 1
depends_on: []
must_haves:
  - "packages/ci/ with action.yml and TypeScript action code"
  - "GitHub Action fetches PR diff, sends to Claude, posts inline comments"
  - "Critical findings block merge via check status"
---

# Phase 6, Plan 1: CI/CD AI Review GitHub Action

## Goal
Complete GitHub Action package that reviews PRs using Claude with AGENTS.md context.

## Tasks

<task type="auto">
  <n>Create CI package scaffold with action.yml</n>
  <files>packages/ci/package.json, packages/ci/action.yml, packages/ci/tsconfig.json</files>
  <action>
    Create packages/ci/ with:
    - package.json: @draht/ci, deps: @anthropic-ai/sdk, @octokit/rest
    - action.yml: GitHub Action definition with inputs (model, agents-md-path, severity-threshold, anthropic-api-key)
    - tsconfig.json extending base
    - Action runs using: bun run packages/ci/src/action.ts
  </action>
  <verify>cat packages/ci/action.yml | head -20</verify>
  <done>Action.yml exists with proper inputs/outputs</done>
</task>

<task type="auto">
  <n>Implement PR diff fetcher</n>
  <files>packages/ci/src/github.ts</files>
  <action>
    Create GitHub API helpers:
    - getPRDiff(token, owner, repo, prNumber): fetch diff via octokit
    - postReviewComments(token, owner, repo, prNumber, comments): post inline review comments
    - setCheckStatus(token, owner, repo, sha, status, summary): set commit check status
    - Types: ReviewComment { path, line, body, severity }
  </action>
  <verify>cat packages/ci/src/github.ts | head -10</verify>
  <done>GitHub API helpers for diff, comments, and check status</done>
</task>

<task type="auto">
  <n>Implement Claude review logic</n>
  <files>packages/ci/src/reviewer.ts</files>
  <action>
    Create review logic:
    - reviewDiff(diff, agentsMdContent, model): send to Claude, parse structured response
    - Prompt: system prompt includes AGENTS.md, user message has diff, ask for JSON array of findings
    - Finding type: { path, line, severity, message, suggestion }
    - Severity: 'info' | 'warning' | 'critical'
    - Parse Claude response as JSON (with fallback for non-JSON responses)
  </action>
  <verify>cat packages/ci/src/reviewer.ts | head -10</verify>
  <done>Claude review returns structured findings from PR diff</done>
</task>

<task type="auto">
  <n>Implement action entry point</n>
  <files>packages/ci/src/action.ts</files>
  <action>
    Main entry point that:
    1. Read inputs from env (GITHUB_TOKEN, INPUT_MODEL, etc.)
    2. Parse PR event from GITHUB_EVENT_PATH
    3. Fetch diff via getPRDiff
    4. Read AGENTS.md from configured path
    5. Call reviewDiff
    6. Post findings as inline comments
    7. If any finding >= severity threshold â†’ set check to failure
    8. Output summary to GITHUB_STEP_SUMMARY
  </action>
  <verify>cat packages/ci/src/action.ts | head -10</verify>
  <done>Action entry point orchestrates full review pipeline</done>
</task>
