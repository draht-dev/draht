---
phase: 7
plan: 1
depends_on: []
must_haves:
  - "packages/orchestrator/ with ticket decomposer and orchestration engine"
  - "Sub-tasks have dependency graph and agent type assignment"
  - "Sequential execution with result synthesis"
---

# Phase 7, Plan 1: Orchestrator Package

## Tasks

<task type="auto">
  <n>Create orchestrator package with types</n>
  <files>packages/orchestrator/package.json, packages/orchestrator/tsconfig.json, packages/orchestrator/src/types.ts</files>
  <action>
    Create packages/orchestrator/ with:
    - package.json: @draht/orchestrator, dep on @anthropic-ai/sdk
    - types.ts: SubTask, TaskPlan, AgentType, OrchestratorState, ExecutionResult
    - AgentType: 'research' | 'implement' | 'test' | 'review'
    - SubTask: { id, title, description, agentType, dependsOn: string[], status, result? }
    - TaskPlan: { taskId, description, subTasks: SubTask[], createdAt }
    - OrchestratorState: { plan, currentSubTask, completedSubTasks, failures }
  </action>
  <verify>cat packages/orchestrator/src/types.ts | head -20</verify>
  <done>Core types defined for orchestration</done>
</task>

<task type="auto">
  <n>Implement ticket decomposer</n>
  <files>packages/orchestrator/src/decomposer.ts</files>
  <action>
    TicketDecomposer class:
    - constructor(apiKey: string, model?: string)
    - async decompose(ticket: string, projectContext?: string): Promise<TaskPlan>
    - Sends ticket + context to Claude, asks for structured sub-task breakdown
    - Prompt instructs Claude to output JSON with sub-tasks, dependencies, agent types
    - Validates and normalizes response
  </action>
  <verify>cat packages/orchestrator/src/decomposer.ts | head -10</verify>
  <done>Decomposer breaks tickets into agent-sized sub-tasks</done>
</task>

<task type="auto">
  <n>Implement orchestration engine</n>
  <files>packages/orchestrator/src/engine.ts</files>
  <action>
    OrchestratorEngine class:
    - constructor(apiKey: string, model?: string)
    - async execute(plan: TaskPlan, onProgress?: callback): Promise<ExecutionResult>
    - Topologically sorts sub-tasks by dependencies
    - Executes each sub-task sequentially via Claude with focused prompt per agent type
    - Collects results, handles failures (retry once, then mark failed)
    - async synthesize(results: SubTaskResult[]): Promise<string> — combine sub-agent outputs
    - Persists state to disk for resumability
  </action>
  <verify>cat packages/orchestrator/src/engine.ts | head -10</verify>
  <done>Engine executes sub-tasks in dependency order and synthesizes results</done>
</task>

<task type="auto">
  <n>Create barrel exports and extension</n>
  <files>packages/orchestrator/src/index.ts, packages/orchestrator/src/extension.ts</files>
  <action>
    index.ts: export all types, TicketDecomposer, OrchestratorEngine
    
    extension.ts: coding agent extension with /orchestrate command:
    - /orchestrate <description> — decompose and execute
    - /orchestrate plan <description> — decompose only, show plan
    - /orchestrate resume — resume from saved state
  </action>
  <verify>cat packages/orchestrator/src/index.ts</verify>
  <done>Package exports and extension command ready</done>
</task>
