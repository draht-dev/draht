---
phase: 13
plan: 1
depends_on: []
must_haves:
  - "packages/router/ exists with config schema and core routing logic"
---

# Phase 13, Plan 1: Router Config & Core

## Goal
Create the @draht/router package with config schema, role definitions, and core routing logic that resolves role→model with fallback chains.

## Context
- Uses existing @draht/ai providers (Anthropic, Google, DeepSeek, OpenAI, Bedrock, Vertex)
- Config lives in `.draht/router.json` (project) with `~/.draht/router.json` (global fallback)
- NO OpenRouter — direct API calls only

## Tasks

<task type="auto">
  <n>1. Package scaffold</n>
  <files>packages/router/package.json, packages/router/tsconfig.json, packages/router/tsconfig.build.json, packages/router/src/index.ts</files>
  <action>
    Create packages/router/ with:
    - package.json: name "@draht/router", version matching monorepo (0.55.3), type "module", main "./dist/index.js", types "./dist/index.d.ts", dependency on @draht/ai
    - tsconfig.json extending ../../tsconfig.json
    - tsconfig.build.json for build output to dist/
    - src/index.ts barrel export
  </action>
  <verify>File exists and package.json is valid JSON</verify>
  <done>packages/router/ scaffold exists</done>
</task>

<task type="auto">
  <n>2. Config schema & types</n>
  <files>packages/router/src/types.ts, packages/router/src/config.ts</files>
  <action>
    Create types.ts with:
    - RouterRole type: "architect" | "implement" | "boilerplate" | "quick" | "review" | "docs" | string (extensible)
    - ModelRef: { provider: string, model: string }
    - RoleConfig: { primary: ModelRef, fallbacks: ModelRef[] }
    - RouterConfig: Record<RouterRole, RoleConfig>
    - DEFAULT_CONFIG with the specified defaults

    Create config.ts with:
    - loadConfig(): loads .draht/router.json, falls back to ~/.draht/router.json, falls back to DEFAULT_CONFIG
    - saveConfig(config, scope: "project" | "global"): writes to appropriate location
    - mergeConfig(project, global): project overrides global per-role
  </action>
  <verify>bun run build in packages/router succeeds</verify>
  <done>Config types and loader exist</done>
</task>

<task type="auto">
  <n>3. Core router</n>
  <files>packages/router/src/router.ts</files>
  <action>
    Create router.ts with:
    - class ModelRouter:
      - constructor(config?: RouterConfig) — loads config if not provided
      - resolve(role: RouterRole): ModelRef — returns primary for role
      - resolveWithFallbacks(role: RouterRole): ModelRef[] — returns [primary, ...fallbacks]
      - async route(role: RouterRole, fn: (model: ModelRef) => Promise<T>): Promise<T> — tries primary, on error tries fallbacks in order
      - isRetryableError(error: unknown): boolean — rate limit (429), timeout, 5xx
    - Export from index.ts
  </action>
  <verify>bun run build in packages/router succeeds</verify>
  <done>Core router class with fallback logic exists</done>
</task>

---
Created: 2026-02-28 20:50:00
