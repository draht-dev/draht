---
phase: 13
plan: 2
depends_on: [1]
must_haves:
  - "CLI commands: draht router set/show/test"
---

# Phase 13, Plan 2: Router CLI & Fallback

## Goal
Add CLI commands for router config management and test the fallback mechanism.

## Context
- CLI integrates into the existing draht binary or as standalone subcommand
- Fallback triggers on 429, 5xx, timeout errors

## Tasks

<task type="auto">
  <n>1. CLI commands</n>
  <files>packages/router/src/cli.ts</files>
  <action>
    Create cli.ts with subcommands:
    - `router show`: pretty-print current config (merged project+global), showing each role with primary and fallbacks
    - `router set <role> <provider/model> [--fallback provider/model,...]`: update role config, save to project scope by default (--global for global)
    - `router test [role]`: dry-run resolve for each role (or specific role), print which model would be selected
    - Parse provider/model from "provider/model" string format
    - Export as registerRouterCommands(program) for integration
  </action>
  <verify>bun run build in packages/router succeeds</verify>
  <done>CLI commands for router management exist</done>
</task>

<task type="auto">
  <n>2. Tests</n>
  <files>packages/router/src/__tests__/router.test.ts, packages/router/src/__tests__/config.test.ts</files>
  <action>
    Create tests using bun:test:
    - config.test.ts: test loadConfig with defaults, test mergeConfig precedence, test saveConfig
    - router.test.ts: test resolve returns primary, test resolveWithFallbacks returns chain, test route() falls back on error, test isRetryableError
    - Mock file system for config loading
  </action>
  <verify>cd packages/router && bun test</verify>
  <done>Tests pass for config and router</done>
</task>

---
Created: 2026-02-28 20:50:00
