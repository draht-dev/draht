---
phase: 13
plan: 3
depends_on: [1, 2]
must_haves:
  - "Cost tracking writes to .draht/cost-log.jsonl"
  - "Coding agent extension auto-selects model by task type"
---

# Phase 13, Plan 3: Cost Tracking & Coding Agent Extension

## Goal
Add per-role/session cost tracking and a coding-agent extension for automatic model selection.

## Context
- Cost log at .draht/cost-log.jsonl with timestamp, role, model, tokens, estimated cost
- Extension hooks into coding-agent's extension system

## Tasks

<task type="auto">
  <n>1. Cost tracker</n>
  <files>packages/router/src/cost.ts</files>
  <action>
    Create cost.ts:
    - CostEntry: { timestamp: string, role: string, model: string, inputTokens: number, outputTokens: number, estimatedCostUsd: number, sessionId: string }
    - COST_PER_MILLION_TOKENS: rough estimates per model family
    - logCost(entry: CostEntry, logPath?: string): append to .draht/cost-log.jsonl
    - getSessionCosts(sessionId: string, logPath?: string): read and filter
    - getRoleCosts(role: string, logPath?: string): aggregate by role
    - Export from index.ts
  </action>
  <verify>bun run build in packages/router succeeds</verify>
  <done>Cost tracking module exists</done>
</task>

<task type="auto">
  <n>2. Coding agent extension</n>
  <files>packages/router/src/extension.ts</files>
  <action>
    Create extension.ts:
    - Export a coding-agent extension that:
      - On session start, loads router config
      - Provides a selectModel(taskType: string) function that maps task types to roles:
        - "planning" | "architecture" → architect
        - "implementation" | "coding" → implement
        - "scaffold" | "boilerplate" → boilerplate
        - "question" | "quick" → quick
        - "review" | "pr-review" → review
        - "documentation" | "readme" → docs
      - Exposes router.show and router.cost commands
    - Follow the extension pattern from packages/coding-agent/src/core/extensions/types.ts
  </action>
  <verify>bun run build in packages/router succeeds</verify>
  <done>Coding agent extension for model routing exists</done>
</task>

<task type="auto">
  <n>3. Package README</n>
  <files>packages/router/README.md</files>
  <action>
    Create README.md covering:
    - What the router does
    - Config format with example
    - CLI usage
    - Fallback behavior
    - Cost tracking
    - Default role→model mapping table
  </action>
  <verify>File exists and is readable markdown</verify>
  <done>Package documented</done>
</task>

---
Created: 2026-02-28 20:50:00
