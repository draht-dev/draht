---
phase: 14
plan: 2
depends_on: [1]
must_haves:
  - "post-task hook runs tests and rejects on failure"
  - "quality gate checks coverage threshold"
---

# Phase 14, Plan 2: TDD Hooks & Quality Gate

## Goal
Enhance post-task and quality gate hooks to enforce TDD.

## Tasks

<task type="auto">
  <n>1. Post-task hook runs tests</n>
  <files>~/.opencode/hooks/draht-post-task.js</files>
  <action>
    After the type check in the post-task hook, add test execution:
    - Run `bun test` (or detect test runner from package.json)
    - If tests fail, log warning: "⚠️  Tests failed after task"
    - Track test count in the execution log entry
  </action>
  <verify>Hook script is valid Node.js</verify>
  <done>Post-task runs tests</done>
</task>

<task type="auto">
  <n>2. Quality gate coverage threshold</n>
  <files>~/.opencode/hooks/draht-quality-gate.js</files>
  <action>
    Add a coverage check section to the quality gate:
    - Try running `bun test --coverage` and parse output
    - If coverage data available, check against threshold (default 80%)
    - Report as warning (not error) since not all packages have coverage setup
  </action>
  <verify>Quality gate script is valid Node.js</verify>
  <done>Quality gate includes coverage check</done>
</task>

---
Created: 2026-02-28 20:55:00
